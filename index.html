<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evolution Studio Pro (Final Fix)</title>
<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

<style>
    :root {
        --bg-body: #0f172a;
        --bg-card: #1e293b;
        --bg-input: #334155;
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --text-main: #f8fafc;
        --text-muted: #94a3b8;
        --border: #475569;
        --danger: #ef4444;
        --success: #10b981;
        --radius: 8px;
        --h-input: 45px;
    }

    * { box-sizing: border-box; outline: none; }

    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--bg-body);
        color: var(--text-main);
        margin: 0;
        padding: 40px 20px;
        font-size: 14px;
        line-height: 1.5;
    }

    /* --- LAYOUT GRID --- */
    .container {
        max-width: 1400px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 25px;
        align-items: start;
    }

    @media (max-width: 1200px) { .container { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }

    /* --- CARDS --- */
    .card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 5px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border);
        color: white;
        font-weight: 700;
        font-size: 1.1rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .card-header i { color: var(--primary); font-size: 1.4rem; }

    /* --- INPUTS --- */
    label {
        display: block;
        color: var(--text-muted);
        font-size: 0.75rem;
        font-weight: 600;
        margin-bottom: 6px;
        text-transform: uppercase;
    }

    input, select, textarea {
        width: 100%;
        height: var(--h-input);
        background: var(--bg-input);
        border: 1px solid transparent;
        color: white;
        padding: 0 15px;
        border-radius: var(--radius);
        font-family: inherit;
        font-size: 0.95rem;
        transition: all 0.2s;
    }

    textarea { height: auto; min-height: 120px; padding: 12px; resize: vertical; }

    input:focus, select:focus, textarea:focus {
        border-color: var(--primary);
        background: #1e293b;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    /* --- BUTTONS --- */
    button {
        height: var(--h-input);
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 0.9rem;
        transition: all 0.2s;
    }
    button:active { transform: translateY(1px); }

    .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
    .btn-primary:hover { opacity: 0.9; }
    
    .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
    .btn-secondary:hover { background: var(--bg-input); color: white; border-color: var(--text-muted); }
    
    .btn-icon { width: var(--h-input); flex-shrink: 0; padding: 0; font-size: 1.2rem; }
    .btn-sm { height: 36px; font-size: 0.8rem; padding: 0 15px; }
    
    .btn-success { background: var(--success); color: #0f172a; }
    .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }
    .btn-danger:hover { background: var(--danger); color: white; }

    .row { display: flex; gap: 12px; }
    .col { flex: 1; }
    .align-center { align-items: center; }

    /* --- IMPORT BAR --- */
    .import-bar {
        max-width: 1400px;
        margin: 0 auto 30px auto;
        background: #111827;
        border: 1px dashed var(--border);
        padding: 15px 20px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .import-bar input { background: transparent; border: none; height: auto; }
    .import-bar input:focus { box-shadow: none; background: transparent; }

    /* --- COVER & PREVIEW --- */
    .cover-section {
        display: flex;
        gap: 15px;
        background: rgba(0,0,0,0.2);
        padding: 15px;
        border-radius: var(--radius);
        margin-bottom: 15px;
    }
    .preview-box {
        width: 110px;
        height: 160px;
        background: #000;
        border-radius: var(--radius);
        overflow: hidden;
        flex-shrink: 0;
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .preview-box img { width: 100%; height: 100%; object-fit: cover; }
    .preview-box i { font-size: 2rem; color: var(--text-muted); opacity: 0.3; }

    /* --- SEARCH RESULTS --- */
    #searchResults {
        position: absolute;
        top: 85px; left: 24px; right: 24px;
        background: var(--bg-card);
        border: 1px solid var(--primary);
        border-radius: var(--radius);
        z-index: 100;
        max-height: 300px;
        overflow-y: auto;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        display: none;
    }
    .search-result-item {
        padding: 12px;
        display: flex;
        gap: 12px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        transition: 0.2s;
    }
    .search-result-item:hover { background: var(--bg-input); }
    .search-result-item img { width: 40px; height: 60px; object-fit: cover; border-radius: 4px; }

    /* --- LIST ITEMS --- */
    .list-item {
        background: #232d42;
        padding: 15px;
        border-radius: var(--radius);
        margin-bottom: 15px;
        border: 1px solid rgba(255,255,255,0.05);
        animation: fadeIn 0.2s ease;
    }
    .sub-section {
        margin-top: 12px;
        padding-left: 15px;
        border-left: 2px solid var(--border);
    }
    .section-title {
        font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; 
        font-weight: 700; margin-bottom: 8px; margin-top: 5px; display: flex; align-items: center; gap: 5px;
    }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    #outputCode {
        font-family: 'Consolas', monospace;
        font-size: 12px;
        color: #e2e8f0;
        background: #0f172a;
        border: 1px solid var(--border);
    }
    #copyStatus { color: var(--success); font-weight: 600; font-size: 12px; margin-right: 10px; }

</style>
</head>
<body>

<!-- IMPORT BAR -->
<div class="import-bar">
    <i class='bx bx-edit' style="font-size:1.5rem; color:var(--primary)"></i>
    <div style="flex:1">
        <div style="font-size:0.75rem; color:var(--text-muted); font-weight:700; text-transform:uppercase;">Edit Mode</div>
        <input type="text" id="importCode" placeholder="Paste your old post HTML code here to edit/add episodes...">
    </div>
    <button onclick="loadFromCode()" class="btn-secondary" style="width:auto; padding: 0 20px;">
        <i class='bx bx-import'></i> Load Data
    </button>
</div>

<div class="container">

    <!-- 1. DETAILS PANEL -->
    <div class="card">
        <div class="card-header"><i class='bx bxs-info-circle'></i> Anime Info (TMDB)</div>
        
        <!-- Search -->
        <div class="form-group" style="position:relative;">
            <label>Search TMDB</label>
            <div class="row">
                <input type="text" id="searchQuery" placeholder="Search (e.g. Naruto)" onkeydown="if(event.key==='Enter') searchTMDB()">
                <select id="tmdbType" style="width:100px;">
                    <option value="tv">TV</option>
                    <option value="movie">Movie</option>
                </select>
                <button onclick="searchTMDB()" class="btn-primary btn-icon"><i class='bx bx-search'></i></button>
            </div>
            <div id="searchResults"></div>
        </div>

        <!-- Cover & Preview -->
        <div class="cover-section">
            <div class="preview-box">
                <img id="previewImg" src="" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                <i class='bx bx-image' style="display:none"></i>
            </div>
            <div class="col" style="display:flex; flex-direction:column; justify-content:center; gap:10px;">
                <div>
                    <label>Poster URL (High Quality)</label>
                    <input type="text" id="posterUrl" onchange="updatePreview(this.value)" placeholder="https://...">
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Description</label>
            <textarea id="description"></textarea>
        </div>
        
        <input type="hidden" id="tmdbId">
    </div>

    <!-- 2. CONTENT PANEL -->
    <div class="card">
        <div class="card-header"><i class='bx bxs-playlist'></i> Episodes & Servers</div>
        
        <div class="row align-center" style="justify-content:space-between; margin-bottom:10px;">
            <label style="margin:0">Episode List</label>
            <button onclick="addEpisode()" class="btn-secondary btn-sm">
                <i class='bx bx-plus'></i> New Episode
            </button>
        </div>
        <div id="episodesContainer"></div>
    </div>

    <!-- 3. DOWNLOADS & EXPORT -->
    <div class="card">
        <div class="card-header"><i class='bx bxs-download'></i> Downloads & Export</div>
        
        <!-- Global Downloads -->
        <div class="row align-center" style="justify-content:space-between; margin-bottom:10px;">
            <label style="margin:0">Global Downloads</label>
            <button onclick="addGlobalDownload()" class="btn-secondary btn-sm">
                <i class='bx bx-plus'></i> Add Link
            </button>
        </div>
        <div id="downloadsContainer" style="margin-bottom:20px;"></div>

        <hr style="border:0; border-top:1px solid var(--border); margin: 0 0 20px 0;">

        <!-- Export -->
        <div class="row align-center" style="justify-content:space-between; margin-bottom:10px;">
            <label style="margin:0">Final Code</label>
            <div>
                <span id="copyStatus"></span>
                <button onclick="copyCode()" class="btn-success btn-sm">
                    <i class='bx bx-copy'></i> Copy
                </button>
            </div>
        </div>
        <textarea id="outputCode" readonly style="height: 200px; margin-bottom:15px;"></textarea>
        
        <button onclick="generatePost()" class="btn-primary" style="width:100%">
            <i class='bx bx-cog'></i> GENERATE HTML
        </button>
    </div>

</div>

<script>
    const API_KEY = "3de80e3c12383c5250000fd8aad71255";
    let episodeCount = 0;
    let autoCast = [];

    // --- SEARCH TMDB ---
    async function searchTMDB(){
        const query = document.getElementById('searchQuery').value;
        const type = document.getElementById('tmdbType').value;
        const res = document.getElementById('searchResults');
        
        if(!query) return;
        
        res.style.display = 'block';
        res.innerHTML = '<div style="padding:15px; text-align:center; color:var(--text-muted)">Searching...</div>';

        try {
            const r = await fetch(`https://api.themoviedb.org/3/search/${type}?api_key=${API_KEY}&query=${query}`);
            const data = await r.json();

            res.innerHTML = '';
            if(!data.results || data.results.length === 0) {
                res.innerHTML = '<div style="padding:15px; text-align:center;">No results found.</div>';
                return;
            }

            data.results.slice(0, 5).forEach(item => {
                const title = item.title || item.name;
                const year = (item.release_date || item.first_air_date || '').split('-')[0];
                const img = item.poster_path ? `https://image.tmdb.org/t/p/w92${item.poster_path}` : '';
                
                const div = document.createElement('div');
                div.className = 'search-result-item';
                div.innerHTML = `
                    <img src="${img}" style="background:#000"> 
                    <div>
                        <div style="font-weight:600; color:white;">${title}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted);">${year} â€¢ ${type.toUpperCase()}</div>
                    </div>`;
                div.onclick = () => selectTMDB(item.id, type);
                res.appendChild(div);
            });
        } catch (e) { res.innerHTML = '<div style="padding:10px; color:var(--danger)">API Error</div>'; }
    }

    async function selectTMDB(id, type) {
        document.getElementById('searchResults').style.display = 'none';
        document.getElementById('tmdbId').value = id;

        try {
            const r = await fetch(`https://api.themoviedb.org/3/${type}/${id}?api_key=${API_KEY}&append_to_response=credits`);
            const d = await r.json();

            const poster = d.poster_path ? `https://image.tmdb.org/t/p/original${d.poster_path}` : "";
            document.getElementById('posterUrl').value = poster;
            updatePreview(poster);
            document.getElementById('description').value = d.overview || "";

            autoCast = [];
            d.credits?.cast?.slice(0, 8).forEach(c => {
                autoCast.push({
                    name: c.name,
                    photo: c.profile_path ? `https://image.tmdb.org/t/p/w185${c.profile_path}` : "",
                    title: c.character || ""
                });
            });

        } catch(e) { alert("Error details"); }
    }

    function updatePreview(url) {
        const img = document.getElementById('previewImg');
        const icon = img.nextElementSibling;
        if(url) { img.src = url; img.style.display='block'; icon.style.display='none'; }
        else { img.style.display='none'; icon.style.display='block'; }
    }

    // --- EPISODES UI ---
    function addEpisode(epVal = '', thumbVal = ''){
        episodeCount++;
        const id = episodeCount;
        const container = document.getElementById('episodesContainer');

        container.insertAdjacentHTML("beforeend",`
        <div class="list-item" id="list_item_${id}">
            <div class="row align-center" style="margin-bottom:10px;">
                <div style="flex:1; font-weight:700; color:white; display:flex; align-items:center; gap:5px;">
                    <i class='bx bx-movie-play'></i> EPISODE
                </div>
                <button class="btn-danger btn-icon" style="width:30px; height:30px; font-size:1rem;" onclick="this.closest('.list-item').remove()"><i class='bx bx-trash'></i></button>
            </div>
            
            <div class="row">
                <div style="flex:1">
                    <input id="ep_${id}" value="${epVal}" placeholder="Ep No (01)">
                </div>
                <div style="flex:2">
                    <input id="ep_thumb_${id}" value="${thumbVal}" placeholder="Thumbnail URL">
                </div>
            </div>

            <div class="sub-section" id="servers_${id}">
                <div class="section-title"><i class='bx bx-server'></i> Streaming Servers</div>
                <button type="button" class="btn-secondary btn-sm" onclick="addServer(${id})" style="width:100%; margin-top:5px;">
                    <i class='bx bx-plus'></i> Add Server
                </button>
            </div>
        </div>
        `);
        return id;
    }

    function addServer(id, name = '', url = ''){
        const container = document.getElementById(`servers_${id}`);
        const btn = container.querySelector('button');
        
        const div = document.createElement('div');
        div.className = 'row';
        div.style.marginTop = '8px';
        div.innerHTML = `
            <input placeholder="Name" value="${name}" style="flex:1">
            <input placeholder="Embed URL" value="${url}" style="flex:2">
            <button type="button" class="btn-danger btn-icon" onclick="this.parentElement.remove()" title="Remove">
                <i class='bx bx-x'></i>
            </button>
        `;
        container.insertBefore(div, btn);
    }

    // --- GLOBAL DOWNLOADS UI ---
    function addGlobalDownload(source='', qual='', size='', url=''){
        const container = document.getElementById('downloadsContainer');
        const div = document.createElement('div');
        div.className = 'row';
        div.style.marginBottom = '8px';
        div.innerHTML = `
            <input placeholder="Source" value="${source}" style="flex:1">
            <input placeholder="Quality" value="${qual}" style="width:80px">
            <input placeholder="Size" value="${size}" style="width:80px">
            <input placeholder="URL" value="${url}" style="flex:2">
            <button type="button" class="btn-danger btn-icon" onclick="this.parentElement.remove()" title="Remove">
                <i class='bx bx-x'></i>
            </button>
        `;
        container.appendChild(div);
    }

    // --- GENERATE ---
    function generatePost(){
        const oldRaw = document.getElementById("importCode").value.trim();
        const posterVal = document.getElementById("posterUrl").value;
        const descVal = document.getElementById("description").value;
        const oldData = parseOldPost(oldRaw);
        
        let html = "";
        html += `<img alt="poster" src="${posterVal}" />\n\n`;
        html += `<iframe class="lazyloaded" data-src="/" src="/" allowfullscreen="true"></iframe>\n\n`;
        html += `<p>${descVal}</p>\n\n`;

        html += `<script>\n`;
        // High Quality Thumbnail Logic
        html += `const defaultThumbnail='${posterVal.replace("/w500/","/original/")}';\n\n`;

        // Episodes
        html += `const episodes=[\n`;
        // We only generate what is IN THE UI now
        for(let i=1; i<=episodeCount; i++){
            const epInput = document.getElementById(`ep_${i}`);
            // Check if element exists (wasn't deleted)
            if(!epInput || !document.getElementById(`list_item_${i}`)) continue;

            html += `{episode:"${epInput.value}",thumb:"${document.getElementById(`ep_thumb_${i}`).value}",videos:{\n`;
            const srvBox = document.getElementById(`servers_${i}`);
            if(srvBox) {
                srvBox.querySelectorAll(".row").forEach(r=>{
                    const v = r.querySelectorAll("input");
                    if(v.length >= 2 && v[0].value && v[1].value) html += `"${v[0].value}":"${v[1].value}",\n`;
                });
            }
            html += `}},\n`;
        }
        html += `];\n\n`;

        // Downloads
        html += `const downloads=[\n`;
        const dlContainer = document.getElementById('downloadsContainer');
        dlContainer.querySelectorAll(".row").forEach(r => {
            const d = r.querySelectorAll("input");
            if(d.length >= 4 && d[0].value && d[3].value){
                html += `{source:"${d[0].value}",quality:"${d[1].value}",size:"${d[2].value}",url:"${d[3].value}"},\n`;
            }
        });
        html += `];\n\n`;

        // Celebrities
        html += `const celebrities=[\n`;
        // Use autoCast or preserve old ones? Let's use autoCast if available, or keep old
        if(autoCast.length > 0){
             autoCast.forEach(c => html += `{name:"${c.name}",photo:"${c.photo}",title:"${c.title}"},\n`);
        } else {
             oldData.celebrities.forEach(c => html += `{name:"${c.name}",photo:"${c.photo}",title:"${c.title}"},\n`);
        }
        html += `];\n<\/script>`;

        document.getElementById('outputCode').value = html;
    }

    // --- PARSE & LOAD ---
    function parseOldPost(rawHtml) {
        const result = { poster: "", description: "", episodes: [], downloads: [], celebrities: [] };
        if (!rawHtml) return result;

        const imgMatch = rawHtml.match(/<img[^>]+src="([^">]+)"/);
        if(imgMatch) result.poster = imgMatch[1];
        const pMatch = rawHtml.match(/<p>([\s\S]*?)<\/p>/);
        if(pMatch) result.description = pMatch[1];

        try {
            // Episodes
            const epMatch = rawHtml.match(/const episodes=\[([\s\S]*?)\];/);
            if (epMatch) {
                epMatch[1].trim().split(/},\s*\n/).filter(s=>s.trim()).forEach(str => {
                    const cln = str.trim().endsWith('}') ? str.trim() : str.trim() + '}';
                    const ep = cln.match(/episode:"(.*?)"/);
                    const th = cln.match(/thumb:"(.*?)"/);
                    const vm = cln.match(/videos:\{([\s\S]*?)\}/);
                    if (ep) {
                        const vids = {};
                        if (vm) {
                            vm[1].trim().split(',').filter(l=>l.includes(':')).forEach(l => {
                                const p = l.split(':');
                                if(p.length >= 2) {
                                    const n = p[0].trim().replace(/"/g, '');
                                    const u = p.slice(1).join(':').trim().replace(/"/g, '').replace(/,$/, '');
                                    vids[n]=u;
                                }
                            });
                        }
                        result.episodes.push({ episode: ep[1], thumb: th?th[1]:"", videos: vids });
                    }
                });
            }
            // Downloads
            const dlMatch = rawHtml.match(/const downloads=\[([\s\S]*?)\];/);
            if (dlMatch) {
                dlMatch[1].trim().split(/},\s*\n/).filter(s=>s.trim()).forEach(str => {
                    const cln = str.trim().endsWith('}') ? str.trim() : str.trim() + '}';
                    const s = cln.match(/source:"(.*?)"/); const q = cln.match(/quality:"(.*?)"/);
                    const z = cln.match(/size:"(.*?)"/);   const u = cln.match(/url:"(.*?)"/);
                    if (s && u) result.downloads.push({ source: s[1], quality: q?q[1]:"", size: z?z[1]:"", url: u[1] });
                });
            }
            // Celebs
            const celMatch = rawHtml.match(/const celebrities=\[([\s\S]*?)\];/);
            if (celMatch) {
                celMatch[1].trim().split(/},\s*\n/).filter(s=>s.trim()).forEach(str => {
                    const cln = str.trim().endsWith('}') ? str.trim() : str.trim() + '}';
                    const n = cln.match(/name:"(.*?)"/); const p = cln.match(/photo:"(.*?)"/); const t = cln.match(/title:"(.*?)"/);
                    if (n) result.celebrities.push({ name: n[1], photo: p?p[1]:"", title: t?t[1]:"" });
                });
            }
        } catch (e) { console.error("Parse Error", e); }
        return result;
    }

    function loadFromCode(){
        const val = document.getElementById('importCode').value;
        if(!val) return alert("Please paste code first.");
        
        const data = parseOldPost(val);

        // 1. Fill Header Info
        if(data.poster) {
            document.getElementById('posterUrl').value = data.poster;
            updatePreview(data.poster);
        }
        if(data.description) document.getElementById('description').value = data.description;

        // 2. Load Episodes into UI
        document.getElementById('episodesContainer').innerHTML = ''; // Clear current UI
        episodeCount = 0; // Reset counter
        
        data.episodes.forEach(ep => {
            const currentId = addEpisode(ep.episode, ep.thumb); // Create Box
            // Add Servers to this box
            Object.keys(ep.videos).forEach(key => {
                addServer(currentId, key, ep.videos[key]);
            });
        });

        // 3. Load Downloads into UI
        document.getElementById('downloadsContainer').innerHTML = ''; // Clear current
        data.downloads.forEach(dl => {
            addGlobalDownload(dl.source, dl.quality, dl.size, dl.url);
        });

        // 4. Load Cast (Internal memory only, not UI)
        autoCast = data.celebrities; // Store so they are re-added on generate

        alert("Data Loaded! You can now see and edit all episodes/downloads.");
    }

    function copyCode(){
        const t = document.getElementById('outputCode');
        t.select(); document.execCommand("copy");
        const s = document.getElementById("copyStatus");
        s.textContent = "Copied!"; setTimeout(()=>s.textContent="", 2000);
    }
</script>

</body>
</html>
